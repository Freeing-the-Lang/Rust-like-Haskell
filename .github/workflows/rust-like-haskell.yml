name: "Rust-like-Haskell — 3OS Build + ProofLedger + Fast Win GHC"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: rust-like-haskell-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ----------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # Setup GHC (FAST MODE for Windows)
      # ----------------------------------------------------------
      - name: Setup GHC (Windows Fast)
        if: matrix.os == 'windows-latest'
        run: |
          echo "[Windows] Installing MSYS2..."
          choco install msys2 --no-progress

          echo "[Windows] Updating pacman..."
          C:\tools\msys64\usr\bin\bash -lc "pacman -Sy --noconfirm"

          echo "[Windows] Installing GHC..."
          C:\tools\msys64\usr\bin\bash -lc "pacman -S --noconfirm ghc"

          echo "[Windows] GHC Version:"
          C:\tools\msys64\usr\bin\bash -lc "ghc --version"

      # ----------------------------------------------------------
      # Setup GHC (Ubuntu/macOS)
      # ----------------------------------------------------------
      - name: Setup GHC (Unix)
        if: matrix.os != 'windows-latest'
        uses: haskell/actions/setup@v2
        with:
          ghc-version: "9.4.8"
          cabal-version: "3.10.1.0"

      # ----------------------------------------------------------
      # Build all .hs modules
      # ----------------------------------------------------------
      - name: Build Rust-like-Haskell (.hs compile)
        run: |
          echo "[Build] Starting Haskell compile..."
          mkdir -p dist

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "[Windows] Compiling via MSYS2..."
            C:\tools\msys64\usr\bin\bash -lc "find src -name '*.hs' -print0 | xargs -0 -I{} ghc -outputdir dist -c {}"

            # Link Main.hs separately
            C:\tools\msys64\usr\bin\bash -lc "ghc src/Main.hs -o dist/out-windows-latest.exe"
          else
            echo "[Unix] Compiling via native GHC..."
            find src -name "*.hs" -print0 | xargs -0 -I{} ghc -outputdir dist -c {}
            ghc src/Main.hs -o dist/out-${{ matrix.os }}
          fi

      # ----------------------------------------------------------
      # Generate ProofLedger (commit, sha256, os info)
      # ----------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          OUT_NAME="out-${{ matrix.os }}"
          [ "${{ matrix.os }}" = "windows-latest" ] && OUT_NAME="out-windows-latest.exe"

          echo "Repository: Rust-like-Haskell" > proofledger-${{ matrix.os }}.txt
          echo "Commit: $GITHUB_SHA" >> proofledger-${{ matrix.os }}.txt
          echo "Branch: $GITHUB_REF_NAME" >> proofledger-${{ matrix.os }}.txt
          echo "OS: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}.txt
          echo "Timestamp: $(date)" >> proofledger-${{ matrix.os }}.txt
          echo "--- SHA256 ---" >> proofledger-${{ matrix.os }}.txt

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            certutil -hashfile dist\\$OUT_NAME SHA256 >> proofledger-${{ matrix.os }}.txt
          else
            shasum -a 256 dist/$OUT_NAME >> proofledger-${{ matrix.os }}.txt
          fi

      # ----------------------------------------------------------
      # Upload Artifacts
      # ----------------------------------------------------------
      - name: Upload Executable
        uses: actions/upload-artifact@v4
        with:
          name: out-${{ matrix.os }}
          path: dist/

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}.txt
          path: proofledger-${{ matrix.os }}.txt
